<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caixa</title>
    <link rel="stylesheet" type="text/css" href="/templates/css/style.css">
    <link rel="stylesheet" type="text/css" href="/templates/css/caixa.css">
    <style>
        @media (max-width: 24rem) {
            div .row {
                display: block !important;
            }
        }
        
        label {
            color: #000459;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script>
        var formatter = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
        });
    </script>
</head>

<body>
    <%- include('../componentes/menu.ejs'); -%>
        <input type="hidden" name="idMesa" id="idMesa" value="<%=idMesa%>">
        <input type="hidden" name="idCaixa" id="idCaixa" value="<%=idCaixa%>">

        <div class="caixa">
            <div class="logo">
                <!-- <img id="cliente" src="images/img/mesa.png" alt=""> -->
            </div>
            <div style="overflow-y: scroll;" class="tabela">
                <table id="listItens">
                    <thead>
                        <th>Código</th>
                        <th style="text-align: left !important;">Nome</th>
                        <th>Quantidade</th>
                        <th>Valor Unitário</th>
                        <th>Valor Total</th>

                    </thead>
                    <tbody>
                        <%var total = 0;%>
                            <% produtos.forEach(function(produto){ %>
                                <%if(typeof produto.produto != 'undefined'){%>
                                    <%total+=(parseFloat(produto.quantidade)*parseFloat(produto.valorUnitario))%>
                                        <tr>
                                            <td>
                                                <%=produto.produto.codigo%>
                                            </td>
                                            <td style="text-align: left !important;">
                                                <%=produto.produto.name%>
                                            </td>
                                            <td>
                                                <%=produto.quantidade%>
                                            </td>
                                            <td class="money">
                                                <%=produto.valorUnitario%>
                                            </td>
                                            <td class="money">
                                                <%=(produto.quantidade*produto.valorUnitario)%>
                                            </td>
                                        </tr>
                                        <%}else{%>
                                            <%total+=(parseFloat(produto.valorUnitario))%>
                                                <tr>
                                                    <td><button onclick="showClickHandler('<%=produto._id%>');">Visualizar Sabores</button></td>
                                                    <td style="text-align: left !important;">Pizza com
                                                        <%=produto.quantidade%> fatias</td>
                                                    <td>1</td>
                                                    <td class="money">
                                                        <%=produto.valorUnitario%>
                                                    </td>
                                                    <td class="money">
                                                        <%=produto.valorUnitario%>
                                                    </td>
                                                </tr>
                                                <%}%>
                                                    <% }); %>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="container">
            <!-- <form action="" method="post"> -->

            <!-- <div class="form">
                <label>Valor Unitario: <input type="text" name="" class="input" id="valorUnidade"></label>
            </div>
            <div class="form">
                <label>Valor Total: <input type="text" name="" class="input" id="valorTotal"></label>
            </div> -->


            <!-- <div class="formdivide">
                <div class="form2">
                    <label style="margin-right: 5px;">Quantidade: <input type="text" value="1" class="input" name="" id="quantidade"></label>
                    <label style="width: 70%;">Produto: <input style="width: 100%;" type="text" name="" class="input codigo" id="descricao"></label>
                    <div style="padding-top: 34px;"><button type="submit" id="inserir">Inserir</button></div>
                </div>
            </div>-->
            <div class="row" style="display: inline-flex;">
                <div style="display: flex;margin-left: 4%;margin-top: 2%;">
                    <label style="margin-right: 5px;">SubTotal: <input type="text" value="<%=total%>" readonly disabled name="" class="input" id="subtotal"></label>

                </div>
                <div style="display: flex;margin-left: 4%;margin-top: 2%;">

                    <label style="margin-right: 5px;">Pagamento <input type="text" value="<%=pgto%>" readonly disabled name="" class="input" id="pagamento"></label>

                </div>
                <div style="display: flex;margin-left: 4%;margin-top: 2%;">

                    <label style="margin-right: 5px;">Total <input type="text" value="<%=total-pgto%>" readonly disabled name="" class="input" id="total"></label>

                </div>
                <div style="display: block;margin-top: 2%;margin-left: 2%;">
                    <label>&nbsp;
                        <button class="input green" onclick="pagamentos('<%=idCaixa%>');">Pagamentos</button></label>
                </div>
                <div style="display: block;margin-top: 2%;margin-left: 2%;">
                    <label>&nbsp;
                        <button class="input green">Imprimir</button></label>
                </div>

                <div style="display: block;margin-top: 2%; margin-left: 2%;">
                    <label>&nbsp;
                        <%if(status==0){%>
                            <!-- -->
                    <% if(idMesa==''){%>
                        <button class="input green" onclick="FinalizarPedido('<%=idCaixa%>');">Finalizar</button></label>

                    <% }else{%>
                        <button class="input green" onclick="fecharMesa('<%=idMesa%>');">Finalizar</button></label>

                        <% }
                     }%>

                </div>
            </div>


            <!-- </form> -->
            <a href="/list/categorias/<%=idCaixa%>">
                <div class="float-button">
                    <span>+</span>
                </div>
            </a>
        </div>
        <!-- <div class="info">

        </div> -->

        <dialog class="mdl-dialog" id="modal-example">
            <input type="hidden" id="idMesa">
            <div class="mdl-dialog__content">
                <div>
                    <table id="sabores">
                        <thead>
                            <th>Código</th>
                            <th>Sabor</th>
                            <th>Fatias</th>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="mdl-dialog__actions mdl-dialog__actions--full-width">
                <div class="container-button left">
                    <button onclick="closeClickHandler();" type="button" class="mdl-button">Close</button>
                </div>
                <!-- <div class="container-button right">
                <button type="button" onclick="usarMesa();" class="mdl-button">Usar</button>
            </div> -->
            </div>
        </dialog>


        <dialog class="mdl-dialog" id="modalpagamento">
            <input type="hidden" id="id_caixa">
            <div class="mdl-dialog__content">
                <div>
                    <table id="pgto">
                        <thead>
                            <th>Valor</th>
                            <th>Tipo</th>
                            <th>Acao</th>
                        </thead>
                        <tbody>
                            <%pagamentos.forEach(function(pagamento){%>

                                <tr>
                                    <td>
                                        <%=pagamento.valor%>
                                    </td>
                                    <td>
                                        <%=pagamento.tipo%>
                                    </td>
                                    <td>
                                        <button onclick="busca('<%=pagamento._id%>');">&#9999;</button>
                                    </td>
                                </tr>
                                <%});%>
                        </tbody>
                    </table>
                </div>
                <div>
                    <label for="name">Cliente</label>
                    <select name="cliente" class="form-control" id="cliente" style="margin-top:0;width: 100% !important; font-size: 14px;">
                      <% clientes.forEach(function(cliente){
                            if(cliente.codigo=='0000000001'){%>
                                <option value="<%=cliente._id%>"><%=cliente.name%></option>                                
                                <% }else{%>
                                    <option value="<%=cliente._id%>"><%=cliente.name%></option>
                        
                        <% }});%>
                    </select>
                    <br>
                    <input type="hidden" id="id_pagamento" name="id">
                    <label for="name">Pagamento</label>
                    <select name="tipo" class="form-control" id="tipo" style="width: 100% !important; font-size: 14px;">
                       <option value="dinheiro">Dinheiro</option>  
                       <option value="Cartão de credito">Cartão de Credito</option>
                       <option value="Cartão de Débito">Cartão de Débito</option>
                       <option value="Transferência">Transferência Bancária</option>
                    </select>
                    <br>
                    <label for="name">Valor</label>
                    <input type="text" name="valor" id="valor">
                </div>
                <br>
            </div>
            <hr>
            <div class="mdl-dialog__actions mdl-dialog__actions--full-width">
                <div class="container-button left">
                    <button onclick="closeClickHandler();" type="button" class="mdl-button">Close</button>
                    <button onclick="addPagamento();" type="button" id="addicionar" class="mdl-button">Adicionar</button>
                </div>
                <!-- <div class="container-button right">
        <button type="button" onclick="usarMesa();" class="mdl-button">Usar</button>
    </div> -->
            </div>
        </dialog>
        <%- include('../componentes/rodape.ejs'); -%>
</body>



<script>
    var dialog = document.querySelector('#modal-example');
    if (!dialog.showModal) {
        dialogPolyfill.registerDialog(dialog);
    }
    var pagamento = document.querySelector('#modalpagamento');
    if (!pagamento.showModal) {
        dialogPolyfill.registerDialog(pagamento);
    }

    function pagamentos(idCaixa) {

        document.querySelector('#id_caixa').value = idCaixa;
        pagamento.showModal();

    }

    function closeClickHandler() {
        dialog.close();
        pagamento.close();
    };
    $("#pagamento").val(formatter.format($("#pagamento").val()));
    $("#total").val(formatter.format($("#total").val()));

    function showClickHandler(idProdutoCaixa) {
        // dialog.querySelector('#idMesa').value = idMesa;
        $.ajax({
            type: 'get',
            url: '/caixa/getpizzas/' + idProdutoCaixa,
            contentType: 'application/json'
        }).done(function(data) {
            // console.log(data);
            let table = document.querySelector("table#sabores tbody");
            let tr = '';
            for (let index = 0; index < data.pizzas.length; index++) {
                const element = data.pizzas[index];
                tr += `
                        <tr>
                            <td>${element.produto.codigo}</td>
                            <td>${element.produto.name}</td>
                            <td>${element.fatias}</td>
                        </tr>
                    `;
            }
            table.innerHTML = tr;
        }).fail(function(msg) {
            console.log('FAIL');
        }).always(function(msg) {
            console.log('ALWAYS');
        });
        dialog.showModal();
    };
    // var total = 0.00;
    $("#subtotal").val(formatter.format($("#subtotal").val()));


    let moneys = document.querySelectorAll('td.money');
    for (let index = 0; index < moneys.length; index++) {
        const element = moneys[index];
        // console.log(element, element.innerText);
        element.innerText = formatter.format(element.innerText);
    }

    /*window.onload = function () {
        document.addEventListener("contextmenu", function (e) {
            e.preventDefault();
        }, false);
        document.addEventListener("keydown", function (e) {
            //document.onkeydown = function(e) {
            // "I" key
            if (e.ctrlKey && e.shiftKey && e.keyCode == 73) {
                disabledEvent(e);
            }
            // "J" key
            if (e.ctrlKey && e.shiftKey && e.keyCode == 74) {
                disabledEvent(e);
            }
            // "S" key + macOS
            if (e.keyCode == 83 && (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)) {
                disabledEvent(e);
            }
            // "U" key
            if (e.ctrlKey && e.keyCode == 85) {
                disabledEvent(e);
            }
            // "F12" key
            if (event.keyCode == 123) {
                disabledEvent(e);
            }
        }, false);
        function disabledEvent(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            } else if (window.event) {
                window.event.cancelBubble = true;
            }
            e.preventDefault();
            return false;
        }
    }

    function click() {
        if (event.button == 2 || event.button == 3) {
        oncontextmenu='return false';
        // alert ('Todos os direitos reservados');
        }
    }

document.onmousedown = click
document.oncontextmenu = new Function('return false;');*/

    $('.codigo').on('keypress', function(event) {
        if (event.which == 13) {
            event.preventDefault();
            getProdutoByCod(this.value);
        }
    });

    function getProdutoByCod(codigo) {
        let quantidade = document.querySelector('#quantidade');
        $.ajax({
                method: "GET",
                url: "/list/produto",
                data: {
                    ativo: true,
                    codigo: codigo,
                    refInterna: codigo
                }
            })
            .done(function(dados) {
                // console.log(dados);
                let tBody = document.querySelector('table#listItens tbody');
                for (let index = 0; index < dados.length; index++) {
                    const element = dados[index];
                    let tr = document.createElement('tr');
                    populaTR(tr, element, quantidade.value);
                    tBody.appendChild(tr);
                }
            })
            .fail(function(jqXHR, textStatus, msg) {
                alert(msg);
            });
    }

    function populaTR(tr, item, quantidade) {
        tr.appendChild(createTD(item.codigo));
        tr.appendChild(createTD(item.name));
        tr.appendChild(createTD(quantidade));
        tr.appendChild(createTD(item.precoVenda.$numberDecimal));
        tr.appendChild(createTD((quantidade * item.precoVenda.$numberDecimal).toFixed(2)));
        total = Number.parseFloat(total) + Number.parseFloat((quantidade * item.precoVenda.$numberDecimal).toFixed(2));
        $("#subtotal").val(total.toFixed(2));
    }

    function createTD(value) {
        let td = document.createElement('td');
        let text = document.createTextNode(value);
        td.appendChild(text);
        return td;
    }

    function FinalizarPedido(idCaixa) {
        var total = $('#total').val();
        if (total == "R$ 0,00") {

            $.ajax({
                    method: 'PUT',
                    url: "/delivery/finalizar/" + idCaixa,
                    data: {
                        caixa: idCaixa,
                    },
                    success: function() {
                        window.location.href = "/delivery/delivery";
                    }
                })
                // console.log(total);
        } else {
            window.alert('Valor diferente de zero');
        }
    }



    function fecharMesa(idMesa) {
        var total = $('#total').val();
        if (total == "R$ 0,00") {
            $.ajax({
                type: 'PUT',
                url: '/close/mesa/' + idMesa,
                contentType: 'application/json',
                data: JSON.stringify({}), // access in body
            }).done(function(data) {
                window.location.href = "/list/mesas";
            }).fail(function(msg) {
                console.log('FAIL');
            }).always(function(msg) {
                console.log('ALWAYS');
            });
        } else {
            window.alert('Valor diferente de zero');
        }
    }

    function busca(idPagamento) {
        $.ajax({
            method: 'PUT',
            url: '/pagamento/' + idPagamento,
            success: function(resposta) {
                $('#tipo').val(resposta.tipo);
                $('#valor').val(resposta.valor.$numberDecimal);
                $('#id_pagamento').val(resposta._id);
                $('#cliente').val(resposta.cliente);
            }
        });
    }

    function addPagamento() {
        var id = $('#id_pagamento').val();
        dados = {
            caixa: $('#id_caixa').val(),
            cliente: $('#cliente').val(),
            tipo: $('#tipo').val(),
            valor: $('#valor').val(),
            id: id
        }
        $.ajax({
            method: 'PUT',
            url: '/adicionar/pagamento',
            data: dados,
            success: function(resposta) {
                window.location.reload(true);
            }

        });
        // console.log(dados);

    }
</script>

</html>